---
title: "BTT_LVAD"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(lubridate)
library(gtsummary)
library(cowplot)
library(survival)
library(survminer)
library(ggsurvfit)
library(cmprsk)
library(tidycmprsk)
library(pROC)
library(risksetROC)
library(rsample)
library(sjPlot)
library(coxme)

```

```{r color_schemes}
custom_colors <- c(
  `dark red` = "#660000",
  `bright red` = "#b81d2e",
  `orange` = "#ae6320",
  `yellow`= "#b8a370",
  `green` = "#3ba9a9",
  `white` = "#FFFFFF",
  `grey` = "#C3C1C1",
  `light green` = "#8dd9d7",
  `light yellow` = "#ddd3bb",
  `light orange` = "#e49f62",
  `space sparkle`= "#496061",
  `violet` = "#7A3DE3",
  `sandy brown` = "#FA9E4D")
custom_col <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (drsimonj_colors)
  custom_colors[cols]
}
custom_palettes <- list(
  `main`  = custom_col("green", "yellow", "dark red"),
  `cool`  = custom_col("green", "yellow","orange"),
  `hot`   = custom_col("yellow", "dark red", "sandy brown"),
  `simple` = custom_col("yellow", "dark red"),
  `reallysimple` = custom_col("white", "#00a1d5"),
  `mixed` = custom_col("green", "yellow", "orange", "bright red", "dark red"),
  `distinct` = custom_col("dark red", "bright red", "light yellow", "green","grey"),
  `distinct1` = custom_col("dark red", "bright red",  "green","light yellow","grey"), 
  `bar` = custom_col("green", "grey", "yellow", "orange", "bright red", "dark red"),
  `treatment` = custom_col("dark red","green", "space sparkle", "orange", "violet","yellow","sandy brown","bright red"),
  `exception` = custom_col("dark red", "yellow"),
  `agegroup` = custom_col("bright red", "orange", "yellow", "grey")
)
custom_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- custom_palettes[[palette]]
  if (reverse) pal <- rev(pal)
  colorRampPalette(pal, ...)
}
scale_color_custom <- function(palette = "mixed", discrete = TRUE, reverse = FALSE, ...) {
  pal <- custom_pal(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("colour", paste0("custom_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}
scale_fill_custom <- function(palette = "mixed", discrete = TRUE, reverse = FALSE, ...) {
  pal <- custom_pal(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("custom_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

```


# Filter and pivot data by relevant dates




``` {r data cleaning}


tx_list <- thoracic_followup_data_2025q2 %>% select(TRR_ID_CODE, PT_CODE, PX_STAT, PX_STAT_DATE) %>% 
  group_by(TRR_ID_CODE) %>% filter(PX_STAT == "A" | PX_STAT == "D" | PX_STAT == "R") %>% arrange(PX_STAT_DATE) %>%
  filter(row_number() == n())


cand_list = thoracic_data_2025q2 %>% select(PT_CODE, WL_ID_CODE, TRR_ID_CODE, INIT_DATE, INIT_STAT, COMPOSITE_DEATH_DATE, INIT_AGE, WL_ORG, END_DATE, REM_CD, LISTING_CTR_CODE, END_STAT, GENDER, ABO, THORACIC_DGN, TCR_DGN, ETHNICITY, ETHCAT, BMI_TCR, BMI_CALC, ECMO_TCR, IABP_TCR, INOTROPES_TCR, VAD_DEVICE_TY_TCR, VENTILATOR_TCR, INIT_WGT_KG_CALC, REGION) %>% 
  filter(INIT_AGE < 18) %>% filter(WL_ORG == "HR") %>% 
  filter(INIT_DATE >= mdy("03-22-2016") & INIT_DATE <= mdy("03-31-2025")) %>%
  mutate(
    period = case_when(
      INIT_DATE >= mdy("07-01-2017") & INIT_DATE <= mdy("03-31-2021") ~ "pre-nhrb",
      INIT_DATE >= mdy("07-01-2021") & INIT_DATE <= mdy("03-31-2025") ~ "post-nhrb",
      TRUE ~ "other"),
    initial_status = case_when(
      grepl("2010", INIT_STAT) ~ "1A",
      grepl("2020", INIT_STAT) ~ "1B",
      grepl("2030", INIT_STAT) ~ "2",
      grepl("2999", INIT_STAT) ~ "Inactive"),
    TX_DATE = ifelse(REM_CD == 4, END_DATE, NA),
    TX_DATE = as.Date(TX_DATE, origin = "1970-01-01")) %>% filter(initial_status != "Inactive")  


#split data into single and multiple registrations
single_registrations = cand_list %>% 
  group_by(PT_CODE) %>%
  filter(n() == 1)

multiple_registrations = cand_list %>%
  group_by(PT_CODE) %>%
  filter(n() > 1)


#distinguish type of multiple registration (concurrents must be collapsed into single listing)
multiple_registrations = multiple_registrations %>% arrange(INIT_DATE) %>%
  mutate(list_type = case_when(
    INIT_DATE < dplyr::lag(END_DATE) ~ "concurrent",
    END_DATE > dplyr::lead(INIT_DATE) ~ "concurrent",
    TRUE ~ "sequential")) 

multiple_registrations = multiple_registrations[order(multiple_registrations$PT_CODE, multiple_registrations$END_DATE), ]

 
multiple_registrations$transplant_num <- 1 
for (i in 2:nrow(multiple_registrations)) {
  if (!is.na(multiple_registrations$PT_CODE[i-1]) && 
      !is.na(multiple_registrations$PT_CODE[i]) && 
      !is.na(multiple_registrations$TX_DATE[i-1]) && 
      !is.na(multiple_registrations$TX_DATE[i]) &&
      multiple_registrations$PT_CODE[i-1] == multiple_registrations$PT_CODE[i] &&
      multiple_registrations$TX_DATE[i-1] != multiple_registrations$TX_DATE[i]) {
    
    multiple_registrations$transplant_num[i] = multiple_registrations$transplant_num[i-1] + 1
  }
}

for (i in 2:nrow(multiple_registrations)) {
  if (!is.na(multiple_registrations$PT_CODE[i-1]) && 
      !is.na(multiple_registrations$PT_CODE[i]) && 
      multiple_registrations$PT_CODE[i-1] == multiple_registrations$PT_CODE[i] &&
      !is.na(multiple_registrations$transplant_num[i-1]) && 
      multiple_registrations$transplant_num[i-1] != multiple_registrations$transplant_num[i] &&
      multiple_registrations$transplant_num[i-1] != 1) {
    
    multiple_registrations$transplant_num[i] = multiple_registrations$transplant_num[i-1]
  }
}

multiple_registrations$transplant_num[multiple_registrations$list_type == 'sequential'] <- 0 

for(i in 1:(nrow(multiple_registrations)-1)) { 
  if(multiple_registrations$PT_CODE[i] == multiple_registrations$PT_CODE[i+1] &
     multiple_registrations$list_type[i] == 'concurrent' & multiple_registrations$list_type[i+1] == 'concurrent' &
     !is.na(multiple_registrations$TX_DATE[i]) & !is.na(multiple_registrations$TX_DATE[i+1]) &
     multiple_registrations$TX_DATE[i] < multiple_registrations$TX_DATE[i+1] ) {
    
    multiple_registrations$TX_DATE[i] <- multiple_registrations$TX_DATE[i+1] ##if PERS_ID is the same as the NEXT row, both have concurrent listings, transplant dates for both are not NA, and transplant date is earlier than the next row's transplant date - update to next row's transplant date
  }}


sequential_lists <- multiple_registrations %>%
  filter(list_type == "sequential") %>%
  mutate(min_list_date = INIT_DATE)  

multiple_registrations <- multiple_registrations %>% 
  group_by(PT_CODE, transplant_num) %>%
  mutate(min_list_date = min(INIT_DATE, na.rm=T))

multiple_registrations <- multiple_registrations %>% mutate
max_retransplants <- max(multiple_registrations$transplant_num) 

collapsed_concurrent_registrations <- NULL 
for(i in 1:max_retransplants) {
  collapsed_concurrent_registrations <- rbind(collapsed_concurrent_registrations, 
        
  multiple_registrations %>%
    filter(list_type == "concurrent" & transplant_num == i) %>% 
    mutate(last_wait_date = max(END_DATE, na.rm = TRUE)) %>% 
    fill(TX_DATE, .direction = "up") %>%
    fill(REM_CD, .direction = "up") %>%
    select(-c(END_DATE, INIT_DATE)) %>%
    filter(row_number() == 1) %>%  
    mutate(last_wait_date = case_when(
      TX_DATE < last_wait_date ~ TX_DATE,
      TRUE ~ last_wait_date)))}

##recombine separated data frames

#recombined data
cand_list <- bind_rows(single_registrations %>% ungroup(), 
                       sequential_lists %>% ungroup(), 
                       collapsed_concurrent_registrations %>% ungroup()) 

#fix listing date 
cand_list = cand_list %>% 
  mutate(
    min_list_date = if_else(is.na(min_list_date), as.Date(INIT_DATE), as.Date(min_list_date)))


cand_hx_list = cand_list %>% 
  mutate(INIT_DATE = ifelse(is.na(INIT_DATE), min_list_date, INIT_DATE),
         END_DATE = ifelse(is.na(END_DATE), last_wait_date, END_DATE),
         INIT_DATE = as.Date(INIT_DATE, origin = "1970-01-01"),
         END_DATE = as.Date(END_DATE, origin = "1970-01-01")) %>%
  select(-list_type, -transplant_num, -min_list_date, -last_wait_date) %>% 
  left_join(thoracic_wlhistory_data_2025q2 %>% select(WL_ID_CODE, CHG_DATE, CHG_TY, UNOS_CAND_STAT_CD), by = "WL_ID_CODE") %>%
  group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>%
  mutate(
    STATUS = case_when(
      grepl("2010", UNOS_CAND_STAT_CD) ~ "1A",
      grepl("2020", UNOS_CAND_STAT_CD) ~ "1B",
      grepl("2030", UNOS_CAND_STAT_CD) ~ "2",
      grepl("2999", UNOS_CAND_STAT_CD) ~ "Inactive")) %>%
  filter(row_number() > 1) %>% distinct(WL_ID_CODE, CHG_DATE, .keep_all = TRUE) 
   

status1ajustifications = thoracic_stat1a %>% 
  mutate(RequestedCandStatCd = 2010,
         EXCEPTION = REQ6_CRITERIA_NOT_MET) %>%
  select(WL_ID_CODE, EXCEPTION, UPGRADE_EXTDATE, RequestedCandStatCd) 


status1bjustifications = thoracic_stat1b %>% 
  mutate(RequestedCandStatCd = 2020,
         EXCEPTION = REQ3_CRITERIA_NOT_MET) %>%
  select(WL_ID_CODE, EXCEPTION, UPGRADE_EXTDATE, RequestedCandStatCd) 

 
status_exception_justifications = rbind(status1ajustifications, status1bjustifications)


total_exceptions = cand_list %>% left_join(status_exception_justifications, by = "WL_ID_CODE")



cand_hx_list_episodes = cand_hx_list %>% left_join(status_exception_justifications, by = "WL_ID_CODE") %>%
  mutate(
    matching = ifelse(UNOS_CAND_STAT_CD == RequestedCandStatCd & CHG_DATE == UPGRADE_EXTDATE, 1, 0),
    matching = ifelse(is.na(matching), 0, matching))

cand_hx_list_episodes1 = cand_hx_list_episodes %>% group_by(WL_ID_CODE, CHG_DATE) %>% arrange(CHG_DATE) %>%
  filter(matching == 1)

cand_hx_list_episodes2 = cand_hx_list_episodes %>% group_by(WL_ID_CODE, CHG_DATE) %>% arrange(CHG_DATE) %>%
  filter(matching == 0) %>% slice(1)


cand_hx_list_episodes = rbind(cand_hx_list_episodes1, cand_hx_list_episodes2) %>% ungroup() %>%
  mutate(
    UPGRADE_EXTDATE = ifelse(matching == 0, NA, UPGRADE_EXTDATE),
    UPGRADE_EXTDATE = as.Date(UPGRADE_EXTDATE, origin = "1970-01-01"),
    RequestedCandStatCd = ifelse(matching == 0, NA, RequestedCandStatCd),
    EXCEPTION = ifelse(matching == 0, NA, EXCEPTION)) %>% distinct()

duplicated_rows_1 <- cand_hx_list_episodes %>%
  group_by(WL_ID_CODE, CHG_DATE) %>%
  filter(n() == 1) %>% arrange(CHG_DATE) %>% ungroup()

duplicated_rows_2 <- cand_hx_list_episodes %>%
  group_by(WL_ID_CODE, CHG_DATE) %>%
  filter(n() == 2) %>% arrange(CHG_DATE) %>% filter(matching == 1) %>% ungroup()

duplicated_rows_3 <- cand_hx_list_episodes %>%
  group_by(WL_ID_CODE, CHG_DATE) %>%
  filter(n() > 2) %>% arrange(CHG_DATE) %>% filter(CHG_TY != "D") %>% 
  filter(matching == 1) %>% arrange(UNOS_CAND_STAT_CD) %>% 
  mutate(
    has_exc = case_when(
      any(EXCEPTION == 1) ~ 1,
      TRUE ~ 0))

duplicated_rows_3.1 = duplicated_rows_3 %>% filter(has_exc == 1) %>% filter(EXCEPTION == 1) %>% 
  select(-has_exc) %>% ungroup()

duplicated_rows_3.2 = duplicated_rows_3 %>% filter(has_exc == 0) %>% arrange(UNOS_CAND_STAT_CD) %>% 
  slice(1) %>% select(-has_exc) %>% ungroup()
  
cand_hx_list_episodes = rbind(duplicated_rows_1, duplicated_rows_2, duplicated_rows_3.1, duplicated_rows_3.2) %>% 
  group_by(WL_ID_CODE) %>% arrange(WL_ID_CODE, CHG_DATE) %>% filter(CHG_TY != "D") %>%
  mutate(
    index_of_exception = which(EXCEPTION == 1) [1],
    CHG_END_DATE = dplyr::lead(CHG_DATE),
    CHG_END_DATE = ifelse(is.na(CHG_END_DATE), END_DATE, CHG_END_DATE),
    CHG_END_DATE = as.Date(CHG_END_DATE, origin = "1970-01-01"),
    start = as.numeric(difftime(CHG_DATE, INIT_DATE, units = "days")),
    end = as.numeric(difftime(CHG_END_DATE, INIT_DATE, units = "days")),
    EXCEPTION = ifelse(is.na(EXCEPTION), 0, EXCEPTION)) %>%
  filter(!(row_number() == n() & last(CHG_END_DATE) %in% head(CHG_END_DATE, -1))) %>%
  filter(CHG_END_DATE > CHG_DATE) %>%
  mutate(
    is_last_row = row_number() == n(),
    death = case_when(
      is_last_row == TRUE & (REM_CD == 8 | REM_CD == 13) ~ 1,
      TRUE ~ 0),
    transplant = case_when(
      is_last_row == TRUE & REM_CD == 4 ~ 1,
      TRUE ~ 0),
    death = ifelse(is.na(death), 0, death),
    transplant = ifelse(is.na(transplant), 0, transplant)) 


cand_hx_list_episodes_grouping = cand_hx_list_episodes %>% 
  group_by(grp = cumsum(EXCEPTION == 1)) %>% 
  mutate(numbering = row_number()) %>%
  mutate(
    time_since_exception = as.numeric(difftime(CHG_DATE, first(CHG_DATE), units = "days")),
    new_fill_for_exception = case_when(
      grp > 0 & first(STATUS) == "1A" & UNOS_CAND_STAT_CD == first(UNOS_CAND_STAT_CD) & time_since_exception <= 14 & WL_ID_CODE == first(WL_ID_CODE) ~ 1,
      grp > 0 & first(STATUS) == "1B" & UNOS_CAND_STAT_CD == first(UNOS_CAND_STAT_CD) & WL_ID_CODE == first(WL_ID_CODE) ~ 1,
      TRUE ~ 0),
    EXCEPTION = ifelse(new_fill_for_exception == 1, 1, EXCEPTION))


cand_hx_list_episodes_grouping = cand_hx_list_episodes_grouping %>%
  mutate(EXCEPTION = ifelse(STATUS == "Inactive", NA, EXCEPTION)) %>%
  mutate(STATUS = factor(case_when(
    !(UNOS_CAND_STAT_CD %in% c(1999, 2999)) ~ STATUS))) %>%
  group_by(WL_ID_CODE) %>%
  fill(STATUS, .direction = "down") %>%
  fill(EXCEPTION, .direction = "down") %>%
  ungroup()

cand_hx_list_episodes_grouping = cand_hx_list_episodes_grouping %>%
  mutate(REC_EXCEPTION_EVER = case_when(EXCEPTION == 1 ~ 1)) %>%
  group_by(WL_ID_CODE) %>%
  fill(REC_EXCEPTION_EVER, .direction = "downup") %>%
  ungroup() %>%
  mutate(REC_EXCEPTION_EVER = tidyr::replace_na(REC_EXCEPTION_EVER, 0))

cand_hx_list_episodes_grouping <- cand_hx_list_episodes_grouping %>%
  mutate(
    REC_EXCEPTION_INIT = case_when(
      EXCEPTION == 1 & start == 0 ~ 1)) %>%
  group_by(WL_ID_CODE) %>%
  fill(REC_EXCEPTION_INIT, .direction = "downup") %>%
  ungroup() %>%
  mutate(REC_EXCEPTION_INIT = tidyr::replace_na(REC_EXCEPTION_INIT, 0))

cand_hx_list_episodes_grouping <- cand_hx_list_episodes_grouping %>%
  mutate(
    REC_EXCEPTION_INIT_EVER = factor(
      case_when(
        REC_EXCEPTION_INIT == 1 ~ "Exception at Listing",
        REC_EXCEPTION_EVER == 1 & REC_EXCEPTION_INIT == 0 ~ "Exception after Listing",
        TRUE ~ "No Exception"),
      levels = c("Exception at Listing",
                 "Exception after Listing",
                 "No Exception")))


cand_hx_list_episodes_grouping = cand_hx_list_episodes_grouping %>%
  mutate(
    STATUS = relevel(STATUS, ref = "2"),
    EXCEPTION_STATUS = factor(
      case_when(
        STATUS == "1A" &
          EXCEPTION == 0 ~ "Status 1A No Exception",
        STATUS == "1A" &
          EXCEPTION == 1 ~ "Status 1A Exception",
        STATUS == "1B" &
          EXCEPTION == 0 ~ "Status 1B No Exception",
        STATUS == "1B" &
          EXCEPTION == 1 ~ "Status 1B Exception",
        TRUE ~ "Status 2"),
      levels = c(
        "Status 1A No Exception",
        "Status 1A Exception",
        "Status 1B No Exception",
        "Status 1B Exception",
        "Status 2")),
    EXCEPTION_STATUS = relevel(EXCEPTION_STATUS, ref = "Status 2"))


last_observations = cand_hx_list_episodes %>% group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>% filter(row_number() == n())

```


``` {r fortable1}

fortable1 = cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% slice(1) %>%
  mutate(
    sex = ifelse(GENDER == "M", "Male", "Female"),
    sex = factor(sex, levels = c("Male", "Female")),
    race = case_when(
      ETHCAT == 1 ~ "White",
      ETHCAT == 2 ~ "Black",
      ETHCAT == 4 ~ "Hispanic/Latino",
      ETHCAT == 5 ~ "Asian",
      TRUE ~ "Other"),
    race = factor(race, levels = c("White", "Black", "Hispanic/Latino", "Asian", "Other")),
    REC_EXCEPTION_INIT_EVER = factor(REC_EXCEPTION_INIT_EVER, levels = c("No Exception", "Exception at Listing", "Exception after Listing")),
    age_group = case_when(
      INIT_AGE < 1 ~ "< 1",
      INIT_AGE >= 1 & INIT_AGE < 5 ~ "1-4",
      INIT_AGE >= 5 & INIT_AGE < 12 ~ "5-11",
      INIT_AGE >= 12 ~ "> 12"),
    age_group = factor(age_group, levels = c("< 1", "1-4", "5-11", "> 12")),
    blood_type = factor(
      case_when(
        ABO %in% c("A", "A1", "A2") ~ "A",
        ABO %in% c("A1B", "A2B") ~ "AB",
        TRUE ~ ABO)),
    diagnosis = case_when(
      TCR_DGN > 999 & TCR_DGN < 1007 ~ "Dilated Cardiomyopathy, Non-Ischemic",
      TCR_DGN > 1049 & TCR_DGN < 1100 ~ "Restrictive Cardiomyopathy",
      TCR_DGN == 1203 | (TCR_DGN >= 1205 & TCR_DGN <= 1207) ~ "Congenital Heart Disease",
      TCR_DGN == 1201 ~ "Hypertrophic Cardiomyopathy",
      TCR_DGN >= 1100 & TCR_DGN <= 1199 ~ "Re-Heart Transplant",
      TRUE ~ "Other"),
    diagnosis = factor(diagnosis, levels = c("Dilated Cardiomyopathy, Non-Ischemic", "Restrictive Cardiomyopathy", 
                                             "Congenital Heart Disease", "Hypertrophic Cardiomyopathy", 
                                             "Re-Heart Transplant", "Other")),
    inotropes = ifelse(INOTROPES_TCR == 1, "IV Inotropes", "None"),
    ECMO = ifelse(ECMO_TCR == 1, "ECMO", "None"),
    IABP = ifelse(IABP_TCR == 1, "IABP", "None"),
    ventilation = ifelse(VENTILATOR_TCR == 1, "Mechanical Ventilation", "None"),
    VAD = ifelse(VAD_DEVICE_TY_TCR == 2 | VAD_DEVICE_TY_TCR == 3 | VAD_DEVICE_TY_TCR == 5, "VAD", "None"))

var_label_list <- list(age_group = "Age at Listing (Years)",
                       sex = "Sex",
                       race = "Race",
                       INIT_WGT_KG_CALC = "Weight (Kilograms)",
                       initial_status = "Status at Initial Listing",
                       blood_type = "Blood Type",
                       diagnosis = "Primary Diagnosis",
                       REC_EXCEPTION_INIT_EVER = "Exception Status",
                       VAD = "VAD at Initial Listing",
                       inotropes = "IV Inotropes at Initial Listing",
                       ECMO = "ECMO at Initial Listing",
                       IABP = "IABP at Initial Listing",
                       ventilation = "Mechanical Ventilation at Initial Listing")
labelled::var_label(fortable1) <- var_label_list


fortable1 %>% ungroup() %>%
  dplyr::select(
    age_group, sex, race, INIT_WGT_KG_CALC, blood_type, diagnosis, initial_status, inotropes, ventilation, IABP, VAD, ECMO, REC_EXCEPTION_INIT_EVER) %>%
  tbl_summary(by = REC_EXCEPTION_INIT_EVER, digits = list(all_categorical() ~ c(0, 1))) %>%
  add_p(test.args = all_tests("chisq.test") ~ list(workspace=2e7)) %>%
  add_overall() %>% 
  #remove_row_type(variables = c(pcwp, cardiac_index), type = "missing", level_value = ("(Missing)")) %>%
  remove_row_type(variables = c(INIT_WGT_KG_CALC), type = "missing", level_value = ("(Unknown)")) %>%
  as_gt()




number <- fortable1 %>% group_by(LISTING_CTR_CODE) %>%
  summarise(n = n())

fortable1 <- fortable1 %>% left_join(number) %>% ungroup() %>% group_by(LISTING_CTR_CODE) %>% arrange(n, LISTING_CTR_CODE)
  
groups = fortable1$LISTING_CTR_CODE %>% unique
i = 0
fortable1$center = NA
for (g in groups) {
  i = i + 1
  fortable1[fortable1$LISTING_CTR_CODE == g, ]$center = i
}

rates <- fortable1 %>% ungroup() %>% group_by(LISTING_CTR_CODE) %>%
  summarize(
    prop_applied_exceptions = sum(REC_EXCEPTION_EVER == 1) / n(),
    number_exceptions = sum(REC_EXCEPTION_EVER == 1),
    prop_exceptions_whole = sum(REC_EXCEPTION_EVER == 1) / 6026) %>%
  arrange(-number_exceptions) %>%
  mutate(Cum = cumsum(number_exceptions)) %>%
  mutate(CumProp = cumsum(prop_exceptions_whole))


median(rates$prop_applied_exceptions)


fortable1$REC_EXCEPTION_EVER <- factor(fortable1$REC_EXCEPTION_EVER,
                                       levels = c(0, 1),
                                       labels = c("Standard Criteria Listing", "Received Exception"))

#this plot looks at distribution of candidates who have applied for an exception, stratified by center
centerplot <- ggplot(fortable1, aes(x = center, fill = REC_EXCEPTION_EVER)) +
  geom_bar(position = "stack", stat = "count", width = 0.8) +
  theme_classic() +
  theme(legend.position = "bottom") + 
  theme(axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20)) +
  labs(x = "U.S. Transplant Centers", y = "Number of Candidates") +
  scale_x_continuous(n.breaks = 7) +
  scale_fill_manual(name = "", values = c("#b8a370", "#660000", "#ae6320", "#C3C1C1")) + 
  guides(fill = guide_legend(nrow = 2, byrow=TRUE))


#set up a chi-square test to see per-center differences
by_center_data <- fortable1 %>%
  group_by(LISTING_CTR_CODE) %>%
  summarise(total_patients = n(),
            exceptions = sum(REC_EXCEPTION_EVER == "Received Exception"),
            noexceptions = sum(REC_EXCEPTION_EVER == "Standard Criteria Listing")) 

by_center_data %>% select(exceptions, noexceptions) %>% chisq.test()








```


``` {r fortable2}


fortable2 = cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>% slice(1) %>%
  mutate(
    sex = ifelse(GENDER == "M", "Male", "Female"),
    sex = factor(sex, levels = c("Male", "Female")),
    race = case_when(
      ETHCAT == 1 ~ "White",
      ETHCAT == 2 ~ "Black",
      ETHCAT == 4 ~ "Hispanic/Latino",
      ETHCAT == 5 ~ "Asian",
      TRUE ~ "Other"),
    race = factor(race, levels = c("White", "Black", "Hispanic/Latino", "Asian", "Other")),
    REC_EXCEPTION_INIT_EVER = factor(REC_EXCEPTION_INIT_EVER, levels = c("No Exception", "Exception at Listing", "Exception after Listing")),
    age_group = case_when(
      INIT_AGE < 1 ~ "< 1",
      INIT_AGE >= 1 & INIT_AGE < 5 ~ "1-4",
      INIT_AGE >= 5 & INIT_AGE < 12 ~ "5-11",
      INIT_AGE >= 12 ~ "> 12"),
    age_group = factor(age_group, levels = c("< 1", "1-4", "5-11", "> 12")),
    blood_type = factor(
      case_when(
        ABO %in% c("A", "A1", "A2") ~ "A",
        ABO %in% c("A1B", "A2B") ~ "AB",
        TRUE ~ ABO)),
    diagnosis = case_when(
      TCR_DGN > 999 & TCR_DGN < 1007 ~ "Dilated Cardiomyopathy, Non-Ischemic",
      TCR_DGN > 1049 & TCR_DGN < 1100 ~ "Restrictive Cardiomyopathy",
      TCR_DGN == 1203 | (TCR_DGN >= 1205 & TCR_DGN <= 1207) ~ "Congenital Heart Disease",
      TCR_DGN == 1201 ~ "Hypertrophic Cardiomyopathy",
      TCR_DGN >= 1100 & TCR_DGN <= 1199 ~ "Re-Heart Transplant",
      TRUE ~ "Other"),
    diagnosis = factor(diagnosis, levels = c("Dilated Cardiomyopathy, Non-Ischemic", "Restrictive Cardiomyopathy", 
                                             "Congenital Heart Disease", "Hypertrophic Cardiomyopathy", 
                                             "Re-Heart Transplant", "Other")),
    support = case_when(
      ECMO_TCR == 1 ~ "ECMO",
      INOTROPES_TCR == 1 ~ "Inotropes",
      VAD_DEVICE_TY_TCR == 2 | VAD_DEVICE_TY_TCR == 3 | VAD_DEVICE_TY_TCR == 5 ~ "VAD",
      VENTILATOR_TCR == 1 ~ "Mechanical Ventilation",
      TRUE ~ NA),
    support = factor(support, levels = c("ECMO", "VAD", "Inotropes", "Mechanical Ventilation")),
    initial_status = factor(initial_status, levels = c("1A", "1B", "2")),
    EXCEPTION = factor(EXCEPTION, levels = c(0, 1), labels = c("No Exception", "Exception")))

var_label_list <- list(age_group = "Age at Listing (Years)",
                       sex = "Sex",
                       race = "Race",
                       INIT_WGT_KG_CALC = "Weight (Kilograms)",
                       initial_status = "Status at Initial Listing",
                       blood_type = "Blood Type",
                       diagnosis = "Primary Diagnosis",
                       support = "Support at Listing",
                       EXCEPTION = "Exception Status at Listing",
                       REC_EXCEPTION_INIT_EVER = "Exception Status")
labelled::var_label(fortable2) <- var_label_list


fortable2 %>% ungroup() %>%
  dplyr::select(
    age_group, sex, race, INIT_WGT_KG_CALC, blood_type, diagnosis, EXCEPTION, support, initial_status) %>%
  tbl_summary(by = initial_status, digits = list(all_categorical() ~ c(0, 1))) %>%
  add_p(test.args = all_tests("chisq.test") ~ list(workspace=2e7)) %>%
  add_overall() %>% 
  #remove_row_type(variables = c(pcwp, cardiac_index), type = "missing", level_value = ("(Missing)")) %>%
  remove_row_type(variables = c(support, INIT_WGT_KG_CALC), type = "missing", level_value = ("(Unknown)")) %>%
  as_gt()


```




``` {r first model}
first_model_death <- coxme(Surv(start, end, death) ~ EXCEPTION_STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_grouping)

# first_model_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION_STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_grouping)
    
summary(first_model_death)

first_plot_death = plot_model(
  first_model_death,
  show.values = TRUE,
  value.offset = .3,
  axis.labels = c(
    "Status 2",
    "Status 1A Exception",
    "Status 1A No Exception",
    "Status 1B Exception",
    "Status 1B No Exception"),
  title = "Mixed Effects Model with Center Random Effects",
  axis.title = "Hazard Ratio"
)
# 
# first_plot_transplant = plot_model(
#   first_model_transplant,
#   show.values = TRUE,
#   value.offset = .3,
#   axis.labels = c(
#     "Status 2",
#     "Status 1A Exception",
#     "Status 1A No Exception",
#     "Status 1B Exception",
#     "Status 1B No Exception"),
#   title = "Mixed Effects Model with Center Random Effects",
#   axis.title = "Hazard Ratio"
# )
    
    
```
   
   
``` {r second model}    
second_model_death <- coxme(Surv(start, end, death) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_grouping)
# second_model_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes)


summary(second_model_death)
exp(confint(second_model_death))

second_plot_death = plot_model(
  second_model_death,
  show.values = TRUE,
  value.offset = .3,
  value.size = 6,
  axis.labels = c(
    "Status 1A",
    "Status 1B",
    "Exception"),
  title = "",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality",
  grid.breaks = c(0.1, 1, 10, 100)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = "black")

# 
# 
# summary(second_model_transplant)
# exp(confint(second_model_transplant))
# 
# second_plot_transplant = plot_model(
#   second_model_transplant,
#   show.values = TRUE,
#   value.offset = .3,
#   value.size = 6,
#   axis.labels = c(
#     "Status 1B",
#     "Status 1A",
#     "Exception"),
#   title = "",
#   axis.title = "Hazard Ratio of Pre-Transplant Mortality",
#   grid.breaks = c(0.01, 0.1, 1, 10, 100)) +
#   theme_classic() +
#   theme(text = element_text(size = 20),
#         axis.text.x = element_text(size = 18),
#         axis.title.x = element_text(size = 20),
#         axis.text.y = element_text(size = 18),
#         axis.title.y = element_text(size = 20),
#         legend.text = element_text(size = 20),
#         legend.title = element_text(size = 20))


```


``` {r fixed effects model}
coxph_stat_ex_strat <- coxph(Surv(start, end, death) ~ EXCEPTION + STATUS + strata(LISTING_CTR_CODE), data = cand_hx_list_episodes_grouping)

summary(coxph_stat_ex_strat)
exp(confint(coxph_stat_ex_strat))

fixed_effects_model = plot_model(
  coxph_stat_ex_strat,
  show.values = TRUE,
  value.offset = .3,
  value.size = 6,
  axis.labels = c(
    "Status 1A",
    "Status 1B",
    "Exception"),
  title = "",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality",
  grid.breaks = c(0.01, 0.1, 1, 10, 100)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))



  
```


``` {r check distribution of random effects}
num_tx_by_center <- cand_hx_list_episodes_grouping %>%
  filter(death == 1) %>%
  group_by(LISTING_CTR_CODE) %>%
  count()
#center 602 is close to the "mean" center
for_fe <- cand_hx_list_episodes_grouping %>%
  left_join(num_tx_by_center, by = "LISTING_CTR_CODE") %>%
  filter(n >= 5) %>%
  mutate(LISTING_CTR_CODE = factor(LISTING_CTR_CODE), 
         LISTING_CTR_CODE = relevel(LISTING_CTR_CODE, ref = "00248"))
full_fe <- "Surv(start, end, death) ~ EXCEPTION + STATUS + LISTING_CTR_CODE"
full_fe_model <- coxph(as.formula(full_fe), for_fe)

#centers_excluded <- length(unique(forcoxmodel$CAN_LISTING_CTR_CD)) - length(levels(for_fe$CAN_LISTING_CTR_CD))
sum_fe_model <- summary(full_fe_model)$coefficients

substrRight <- function(x, n) {
  substr(x, nchar(x) - n + 1, nchar(x))
}

fe_coef <- tibble(name = names(full_fe_model$coefficients),
                  beta = unname(sum_fe_model[,2])) %>%
  filter(grepl("LISTING_CTR_CODE", name) == TRUE) %>%
  mutate(LISTING_CTR_CODE = substrRight(name, 5)) %>%
  dplyr::select(-name)


histogram_plot = ggplot(fe_coef, aes(x = beta)) + geom_histogram(breaks = seq(0, 3, 0.5))
s_w_norm_test <- shapiro.test(sum_fe_model)[[2]]

re_effects <- data.frame(ranef(second_model_death)[[1]])
re_effects$LISTING_CTR_CODE <- row.names(re_effects)
colnames(re_effects)[1] <- "re"
#make a center level dataset of random effects

center_re <- re_effects %>%
  mutate(death_hazard = exp(re))
for_spear <- center_re %>%
  filter(LISTING_CTR_CODE %in% fe_coef$LISTING_CTR_CODE) %>%
  left_join(fe_coef %>% dplyr::select(LISTING_CTR_CODE, beta))
spearman_cor <- cor(for_spear$death_hazard, for_spear$beta, method = "spearman")
ggplot(for_spear, aes(x = death_hazard, y = beta)) + geom_point() +
labs(x = "Center-specific hazard of death (RE estimate)",
     y = "Center-specific hazard of death (FE estimate)")



# 
# num_tx_by_center <- cand_hx_list_episodes_grouping %>%
#   filter(transplant == 1) %>%
#   group_by(LISTING_CTR_CODE) %>%
#   count()
# #center 602 is close to the "mean" center
# for_fe <- cand_hx_list_episodes %>%
#   left_join(num_tx_by_center, by = "LISTING_CTR_CODE") %>%
#   filter(n >= 5) %>%
#   mutate(LISTING_CTR_CODE = factor(LISTING_CTR_CODE), 
#          LISTING_CTR_CODE = relevel(LISTING_CTR_CODE, ref = "00248"))
# full_fe <- "Surv(start, end, transplant) ~ EXCEPTION + STATUS + LISTING_CTR_CODE"
# full_fe_model <- coxph(as.formula(full_fe), for_fe)
# 
# #centers_excluded <- length(unique(forcoxmodel$CAN_LISTING_CTR_CD)) - length(levels(for_fe$CAN_LISTING_CTR_CD))
# sum_fe_model <- summary(full_fe_model)$coefficients
# 
# substrRight <- function(x, n) {
#   substr(x, nchar(x) - n + 1, nchar(x))
# }
# 
# fe_coef <- tibble(name = names(full_fe_model$coefficients),
#                   beta = unname(sum_fe_model[,2])) %>%
#   filter(grepl("LISTING_CTR_CODE", name) == TRUE) %>%
#   mutate(LISTING_CTR_CODE = substrRight(name, 5)) %>%
#   dplyr::select(-name)
# 
# 
# ggplot(fe_coef, aes(x = beta)) + geom_histogram(breaks = seq(0, 3, 0.1))
# s_w_norm_test <- shapiro.test(sum_fe_model)[[2]]
# 
# re_effects <- data.frame(ranef(second_model_transplant)[[1]])
# re_effects$LISTING_CTR_CODE <- row.names(re_effects)
# colnames(re_effects)[1] <- "re"
# #make a center level dataset of random effects
# 
# center_re <- re_effects %>%
#   mutate(transplant_hazard = exp(re))
# for_spear <- center_re %>%
#   filter(LISTING_CTR_CODE %in% fe_coef$LISTING_CTR_CODE) %>%
#   left_join(fe_coef %>% dplyr::select(LISTING_CTR_CODE, beta))
# spearman_cor <- cor(for_spear$transplant_hazard, for_spear$beta, method = "spearman")
# ggplot(for_spear, aes(x = transplant_hazard, y = beta)) + geom_point() +
# labs(x = "Center-specific hazard of transplant (RE estimate)",
#      y = "Center-specific hazard of transplant (FE estimate)")


```

``` {r per status models}
#Status 1A ONLY

status1a <- cand_hx_list_episodes_grouping %>%
  filter(STATUS == "1A")

coxme_stat1a_death <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1a)
# coxme_stat1a_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1a)

summary(coxme_stat1a_death)
exp(confint(coxme_stat1a_death))
# 
# summary(coxme_stat1a_transplant)
# exp(confint(coxme_stat1a_transplant))

status1b <- cand_hx_list_episodes_grouping %>%
  filter(STATUS == "1B")

coxme_stat1b_death <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1b)
# coxme_stat1b_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1b)

summary(coxme_stat1b_death)
exp(confint(coxme_stat1b_death))
# 
# summary(coxme_stat1b_transplant)
# exp(confint(coxme_stat1b_transplant))

coxme_stats_ex <- plot_models(
  coxme_stat1a_death,
  coxme_stat1b_death,
  axis.labels = "Exception",
  m.labels = c("Status 1A", "Status 1B"),
  value.size = 6,
  # title = "Mixed Effects Model with Center Random Effects",
  legend.title = "",
  axis.title = "Hazard Ratio",
  spacing = 1,
  show.values = TRUE,
  show.p = TRUE,
  grid.breaks = c(0.1, 1, 10)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = "black")


```






``` {r pre and post nhrb models}


cand_hx_list_episodes_pre_nhrb = cand_hx_list_episodes_grouping %>% filter(period == "pre-nhrb") %>%
  filter(CHG_DATE <= mdy("05-31-2021")) %>%
  mutate(
    death = case_when(
      death == 1 & CHG_END_DATE > mdy("05-31-2021") ~ 0,
      TRUE ~ death),
    transplant = case_when(
      transplant == 1 & CHG_END_DATE > mdy("05-31-2021") ~ 0,
      TRUE ~ transplant))

model_pre_nhrb_death <- coxme(Surv(start, end, death) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_pre_nhrb)
summary(model_pre_nhrb_death)
exp(confint(model_pre_nhrb_death))
# 
# model_pre_nhrb_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_pre_nhrb)
# summary(model_pre_nhrb_transplant)
# exp(confint(model_pre_nhrb_transplant))

pre_nhrb_plot_death = plot_model(
  model_pre_nhrb_death,
  show.values = TRUE,
  value.offset = .3,
  axis.labels = c(
    "Status 1B",
    "Status 1A",
    "Exception"),
  title = "Mixed Effects Model with Center Random Effects",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality, Pre-NHRB",
  grid.breaks = c(0.1, 1, 10, 100)
)

# pre_nhrb_plot_transplant = plot_model(
#   model_pre_nhrb_transplant,
#   show.values = TRUE,
#   value.offset = .3,
#   axis.labels = c(
#     "Status 1B",
#     "Status 1A",
#     "Exception"),
#   title = "Mixed Effects Model with Center Random Effects",
#   axis.title = "Hazard Ratio of Transplantation, Pre-NHRB",
#   grid.breaks = c(0.1, 1, 10, 100)
# )


cand_hx_list_episodes_post_nhrb = cand_hx_list_episodes_grouping %>% filter(period == "post-nhrb") %>%
  filter(CHG_DATE <= mdy("05-31-2025")) %>%
  mutate(
    death = case_when(
      death == 1 & CHG_END_DATE > mdy("05-31-2025") ~ 0,
      TRUE ~ death),
    transplant = case_when(
      transplant == 1 & CHG_END_DATE > mdy("05-31-2025") ~ 0,
      TRUE ~ transplant))

model_post_nhrb_death <- coxme(Surv(start, end, death) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_post_nhrb)
summary(model_post_nhrb_death)
exp(confint(model_post_nhrb_death))

# model_post_nhrb_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = cand_hx_list_episodes_post_nhrb)
# summary(model_post_nhrb_transplant)
# exp(confint(model_post_nhrb_transplant))

post_nhrb_plot_death = plot_model(
  model_post_nhrb_death,
  show.values = TRUE,
  value.offset = .3,
  axis.labels = c(
    "Status 1B",
    "Status 1A",
    "Exception"),
  title = "Mixed Effects Model with Center Random Effects",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality, Post-NHRB",
  grid.breaks = c(0.1, 1, 10, 100)
)

# post_nhrb_plot_transplant = plot_model(
#   model_post_nhrb_transplant,
#   show.values = TRUE,
#   value.offset = .3,
#   axis.labels = c(
#     "Status 1B",
#     "Status 1A",
#     "Exception"),
#   title = "Mixed Effects Model with Center Random Effects",
#   axis.title = "Hazard Ratio of Transplantation, Post-NHRB",
#   grid.breaks = c(0.1, 1, 10, 100)
# )


nhrb_plot_base_death = plot_models(
  model_pre_nhrb_death,
  model_post_nhrb_death,
  show.values = TRUE,
  value.size = 6,
  #value.offset = .3,
  axis.labels = c(
    "Status 1A",
    "Status 1B",
    "Exception"),
  title = "",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality",
  grid.breaks = c(0.1, 1, 10, 100)) + 
  scale_color_manual(
    values = c("blue", "red"), # Specify colors
    labels = c("Pre-NHRB", "Post-NHRB")) 

# 2. Get the plot's data and reorder the "group" factor
nhrb_plot_data_death <- nhrb_plot_base_death$data


# 3. Rebuild the plot with the manually ordered data and the manual color scale
nhrb_plot_death <- nhrb_plot_base_death + 
  ggplot2::aes(color = nhrb_plot_data_death$group) + 
  scale_color_manual(
    values = c("#df8f44", "#00a1d5"),
    labels = c("Post-NHRB", "Pre-NHRB")
  ) +
  labs(color = "Cohort Era") +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = "black")




# nhrb_plot_base_transplant = plot_models(
#   model_pre_nhrb_transplant,
#   model_post_nhrb_transplant,
#   show.values = TRUE,
#   value.size = 6,
#   #value.offset = .3,
#   axis.labels = c(
#     "Status 1B",
#     "Status 1A",
#     "Exception"),
#   title = "",
#   axis.title = "Hazard Ratio of Transplantation",
#   grid.breaks = c(0.01, 0.1, 1, 10, 100)) + 
#   scale_color_manual(
#     values = c("blue", "red"), # Specify colors
#     labels = c("Pre-NHRB", "Post-NHRB")) 
# 
# # 2. Get the plot's data and reorder the "group" factor
# nhrb_plot_data_transplant <- nhrb_plot_base_transplant$data
# 
# 
# # 3. Rebuild the plot with the manually ordered data and the manual color scale
# nhrb_plot_transplant <- nhrb_plot_base_transplant + 
#   ggplot2::aes(color = nhrb_plot_data_transplant$group) + 
#   scale_color_manual(
#     values = c("#374e55", "#b24745"),
#     labels = c("Post-NHRB", "Pre-NHRB")
#   ) +
#   labs(color = "Cohort Era") +
#   theme_classic() +
#   theme(text = element_text(size = 20),
#         axis.text.x = element_text(size = 18),
#         axis.title.x = element_text(size = 20),
#         axis.text.y = element_text(size = 18),
#         axis.title.y = element_text(size = 20),
#         legend.text = element_text(size = 20),
#         legend.title = element_text(size = 20))
# 






status1a_pre_nhrb <- cand_hx_list_episodes_pre_nhrb %>%
  filter(STATUS == "1A")

coxme_stat1a_pre_nhrb <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1a_pre_nhrb)

summary(coxme_stat1a_pre_nhrb)
exp(confint(coxme_stat1a_pre_nhrb))

status1b_pre_nhrb <- cand_hx_list_episodes_pre_nhrb %>%
  filter(STATUS == "1B")

coxme_stat1b_pre_nhrb <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1b_pre_nhrb)

summary(coxme_stat1b_pre_nhrb)
exp(confint(coxme_stat1b_pre_nhrb))

status1a_post_nhrb <- cand_hx_list_episodes_post_nhrb %>%
  filter(STATUS == "1A")

coxme_stat1a_post_nhrb <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1a_post_nhrb)

summary(coxme_stat1a_post_nhrb)
exp(confint(coxme_stat1a_post_nhrb))

status1b_post_nhrb <- cand_hx_list_episodes_post_nhrb %>%
  filter(STATUS == "1B")

coxme_stat1b_post_nhrb <- coxme(Surv(start, end, death) ~ EXCEPTION + (1 | LISTING_CTR_CODE), data = status1b_post_nhrb)

summary(coxme_stat1b_post_nhrb)
exp(confint(coxme_stat1b_post_nhrb))

coxme_stats_ex_nhrb <- plot_models(
  coxme_stat1a_pre_nhrb,
  coxme_stat1b_pre_nhrb,
  coxme_stat1a_post_nhrb,
  coxme_stat1b_post_nhrb,
  axis.labels = "Exception",
  m.labels = c("Status 1A Pre-NHRB", "Status 1B Pre-NHRB", "Status 1A Post-NHRB", "Status 1B Post-NHRB"),
  # title = "Mixed Effects Model with Center Random Effects",
  legend.title = "",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality",
  spacing = 1,
  show.values = TRUE,
  show.p = TRUE,
  grid.breaks = c(0.01, 0.1, 1, 10)
)

```

``` {r sensitivity}

sensitivity_data = cand_hx_list_episodes_grouping %>%
  mutate(
    sex = ifelse(GENDER == "M", "Male", "Female"),
    sex = factor(sex, levels = c("Male", "Female")),
    race = case_when(
      ETHCAT == 1 ~ "White",
      ETHCAT == 2 ~ "Black",
      ETHCAT == 4 ~ "Hispanic/Latino",
      ETHCAT == 5 ~ "Asian",
      TRUE ~ "Other"),
    race = factor(race, levels = c("White", "Black", "Hispanic/Latino", "Asian", "Other")),
    age_group = case_when(
      INIT_AGE < 1 ~ "< 1",
      INIT_AGE >= 1 & INIT_AGE < 5 ~ "1-4",
      INIT_AGE >= 5 & INIT_AGE < 12 ~ "5-11",
      INIT_AGE >= 12 ~ "> 12"),
    age_group = factor(age_group, levels = c("< 1", "1-4", "5-11", "> 12")),
    diagnosis = case_when(
      TCR_DGN > 999 & TCR_DGN < 1007 ~ "Dilated Cardiomyopathy, Non-Ischemic",
      TCR_DGN > 1049 & TCR_DGN < 1100 ~ "Restrictive Cardiomyopathy",
      TCR_DGN == 1203 | (TCR_DGN >= 1205 & TCR_DGN <= 1207) ~ "Congenital Heart Disease",
      TCR_DGN == 1201 ~ "Hypertrophic Cardiomyopathy",
      TCR_DGN >= 1100 & TCR_DGN <= 1199 ~ "Re-Heart Transplant",
      TRUE ~ "Other"),
    diagnosis = factor(diagnosis, levels = c("Dilated Cardiomyopathy, Non-Ischemic", "Restrictive Cardiomyopathy", 
                                             "Congenital Heart Disease", "Hypertrophic Cardiomyopathy", 
                                             "Re-Heart Transplant", "Other")),
    blood_type = factor(
      case_when(
        ABO %in% c("A", "A1", "A2") ~ "A",
        ABO %in% c("A1B", "A2B") ~ "AB",
        TRUE ~ ABO)),
    ecmo = ifelse(ECMO_TCR == 1, 1, 0),
    inotropes = ifelse(INOTROPES_TCR == 1, 1, 0),
    vad = ifelse(VAD_DEVICE_TY_TCR == 2 | VAD_DEVICE_TY_TCR == 3 | VAD_DEVICE_TY_TCR == 5, 1, 0),
    ventilator = ifelse(VENTILATOR_TCR == 1, 1, 0))
    

sensitivity_model_death <- coxme(Surv(start, end, death) ~ EXCEPTION + STATUS + sex + race + age_group + blood_type + diagnosis + ecmo + inotropes + vad + ventilator + (1 | LISTING_CTR_CODE), data = sensitivity_data)

summary(sensitivity_model_death)
exp(confint(sensitivity_model_death))

# sensitivity_model_transplant <- coxme(Surv(start, end, transplant) ~ EXCEPTION + STATUS + sex + race + age_group + blood_type + diagnosis + ecmo + inotropes + vad + ventilator + (1 | LISTING_CTR_CODE), data = sensitivity_data)
# 
# summary(sensitivity_model_transplant)
# exp(confint(sensitivity_model_transplant))

sensitivity_plot_death = plot_model(
  sensitivity_model_death,
  show.values = TRUE,
  value.offset = .3,
  value.size = 6,
  axis.labels = c("Mechanical Ventilation", "Ventricular Assist Device", "Intravenous Inotropes", "ECMO", "Other", "Re-Heart TX", "Hypertrophic Cardiomyopathy", "Congenital Heart Disease", "Restrictive Cardiomyopathy", "O", "B", "AB", "12 Years and Older", "5-11 Years", "1-4 Years", "Other Race", "Asian", "Hispanic/Latino", "Black", "Female", "Status 1A", "Status 1B", "Exception"),
  title = "",
  axis.title = "Hazard Ratio of Pre-Transplant Mortality",
  grid.breaks = c(0.01, 0.1, 1, 10, 100)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))


# sensitivity_plot_transplant = plot_model(
#   sensitivity_model_transplant,
#   show.values = TRUE,
#   value.offset = .3,
#   value.size = 6,
#   axis.labels = c("Mechanical Ventilation", "Ventricular Assist Device", "Intravenous Inotropes", "ECMO", "Other", "Re-Heart TX", "Hypertrophic Cardiomyopathy", "Congenital Heart Disease", "Restrictive Cardiomyopathy", "O", "B", "AB", "12 Years and Older", "5-11 Years", "1-4 Years", "Other Race", "Asian", "Hispanic/Latino", "Black", "Female", "Status 1B", "Status 1A", "Exception"),
#   title = "",
#   axis.title = "Hazard Ratio of Transplantation",
#   grid.breaks = c(0.01, 0.1, 1, 10, 100)) +
#   theme_classic() +
#   theme(text = element_text(size = 20),
#         axis.text.x = element_text(size = 18),
#         axis.title.x = element_text(size = 20),
#         axis.text.y = element_text(size = 18),
#         axis.title.y = element_text(size = 20),
#         legend.text = element_text(size = 20),
#         legend.title = element_text(size = 20))







ggplot(cand_hx_list_episodes_grouping, aes(x = STATUS, fill = REC_EXCEPTION_INIT_EVER)) + 
  geom_bar() + 
  labs(x = "Status", y = "Number of Status Justifications", fill = "")





```


``` {r figure 1}

first_observations = cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>% slice(1) %>% 
  mutate(
    new_exception_status = case_when(
      EXCEPTION == 0 ~ "No Exception",
      EXCEPTION == 1 ~ "Exception at Listing")) %>% ungroup()

last_observations = cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>% filter(row_number() > 1) %>% 
  mutate(
    new_exception_status = case_when(
      EXCEPTION == 0 ~ "No Exception",
      EXCEPTION == 1 ~ "Exception after Listing")) %>% ungroup()

data_for_figure1 = cand_hx_list_episodes %>% filter(!is.na(RequestedCandStatCd)) %>%
#  rbind(first_observations, last_observations) %>%
  mutate(
    STATUS = factor(STATUS, levels = c("1A", "1B", "2"), labels = c("Status 1A", "Status 1B", "Status 2")),
    EXCEPTION = factor(EXCEPTION, levels = c("0", "1"), labels = c("No Exception", "Exception")))


just_files = just_files %>%
  mutate(
    STATUS = factor(RequestedCandStatCd, levels = c("2010", "2020"), labels = c("Status 1A", "Status 1B")),
    EXCEPTION = factor(EXCEPTION, levels = c("0", "1"), labels = c("No Exception", "Exception")))

fig1 = ggplot(data_for_figure1, aes(x = STATUS, fill = EXCEPTION)) + 
  geom_bar() + 
  labs(x = "", y = "Number of Status Justification Files", fill = "") +
  scale_fill_manual(values = c("#00a1d5", "#df8f44")) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))






```


``` {r post_transplant survival}


heart_transplants <- cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% 
  mutate(
    tx = case_when(
      is_last_row == TRUE & REM_CD == 4 ~ 1,
      TRUE ~ 0)) %>% filter(tx == 1) %>%
  left_join(tx_list, by = "PT_CODE") %>% filter(TRR_ID_CODE.x == TRR_ID_CODE.y | is.na(TRR_ID_CODE.y)) %>%
  select(-TRR_ID_CODE.x, -TRR_ID_CODE.y) %>%
  mutate(
    PX_STAT_DATE = case_when(
      is.na(PX_STAT_DATE) & !is.na(COMPOSITE_DEATH_DATE) ~ COMPOSITE_DEATH_DATE,
      is.na(PX_STAT_DATE) & is.na(COMPOSITE_DEATH_DATE) ~ TX_DATE,
      TRUE ~ PX_STAT_DATE),
    PX_STAT = case_when(
      is.na(PX_STAT) & !is.na(COMPOSITE_DEATH_DATE) ~ "D",
      is.na(PX_STAT) & is.na(COMPOSITE_DEATH_DATE) ~ "A",
      TRUE ~ PX_STAT),
    post_transplant_time = as.numeric(difftime(PX_STAT_DATE, TX_DATE, units = "days")),
    #post_transplant_time_year = post_transplant_time / 365.25,
    post_transplant_time = ifelse(post_transplant_time > 365.25, 365.25, post_transplant_time),
    post_transplant_death = ifelse(PX_STAT == "D" & post_transplant_time <= 365.25, 1, 0),
    post_transplant_death = ifelse(is.na(post_transplant_death), 0, post_transplant_death))

    
   

```

``` {r exceptions figures}

# hearts_just_cohorts = heart_transplants %>% filter(period != "other") %>% group_by(period) %>% summarise(median = median(end))




calculations_for_heart_transplants <- heart_transplants %>% 
  mutate(EXCEPTION = ifelse(is.na(EXCEPTION), 0, EXCEPTION)) %>%
  select(WL_ID_CODE, period, EXCEPTION) %>% ungroup() %>% 
  group_by(period) %>% summarise(transplants = n(), exceptions_at_transplant = sum(EXCEPTION), na.rm = TRUE) %>%
  mutate(exceptionproportion = exceptions_at_transplant / transplants) 

calculations_for_heart_transplants <- calculations_for_heart_transplants %>% filter(period != "other")

calculations_for_heart_transplants %>% select(transplants, exceptions_at_transplant) %>% chisq.test()


exception_at_heart_transplant <- heart_transplants %>% filter(EXCEPTION == 1) %>%
  mutate(
    EXCEPTION_STATUS = case_when(
      EXCEPTION == 1 ~ "1A/1B Exception at Time of Transplant")) %>% select(WL_ID_CODE, period, EXCEPTION, EXCEPTION_STATUS, TX_DATE)

total <- heart_transplants %>% mutate(EXCEPTION_STATUS = "Total") %>% select(WL_ID_CODE, period, EXCEPTION, EXCEPTION_STATUS, TX_DATE)


  
barplotdata <- rbind(exception_at_heart_transplant, total) %>% filter(TX_DATE >= mdy("04-01-2016") & TX_DATE <= mdy("06-30-2025")) %>%
  mutate(
    status = factor(EXCEPTION_STATUS, levels = c("Total", "1A/1B Exception at Time of Transplant"))) %>%
  mutate(
    timing_of_transplants = case_when(
      TX_DATE >= mdy("04-01-2016") & TX_DATE <= mdy("06-30-2016") ~ "Apr-Jun 2016",
      TX_DATE >= mdy("07-01-2016") & TX_DATE <= mdy("09-30-2016") ~ "Jul-Sep 2016",
      TX_DATE >= mdy("10-01-2016") & TX_DATE <= mdy("12-31-2016") ~ "Oct-Dec 2016",
      TX_DATE >= mdy("01-01-2017") & TX_DATE <= mdy("03-31-2017") ~ "Jan-Mar 2017",
      TX_DATE >= mdy("04-01-2017") & TX_DATE <= mdy("06-30-2017") ~ "Apr-Jun 2017",
      TX_DATE >= mdy("07-01-2017") & TX_DATE <= mdy("09-30-2017") ~ "Jul-Sep 2017",
      TX_DATE >= mdy("10-01-2017") & TX_DATE <= mdy("12-31-2017") ~ "Oct-Dec 2017",
      TX_DATE >= mdy("01-01-2018") & TX_DATE <= mdy("03-31-2018") ~ "Jan-Mar 2018",
      TX_DATE >= mdy("04-01-2018") & TX_DATE <= mdy("06-30-2018") ~ "Apr-Jun 2018",
      TX_DATE >= mdy("07-01-2018") & TX_DATE <= mdy("09-30-2018") ~ "Jul-Sep 2018",
      TX_DATE >= mdy("10-01-2018") & TX_DATE <= mdy("12-31-2018") ~ "Oct-Dec 2018",
      TX_DATE >= mdy("01-01-2019") & TX_DATE <= mdy("03-31-2019") ~ "Jan-Mar 2019",
      TX_DATE >= mdy("04-01-2019") & TX_DATE <= mdy("06-30-2019") ~ "Apr-Jun 2019",
      TX_DATE >= mdy("07-01-2019") & TX_DATE <= mdy("09-30-2019") ~ "Jul-Sep 2019",
      TX_DATE >= mdy("10-01-2019") & TX_DATE <= mdy("12-31-2019") ~ "Oct-Dec 2019",
      TX_DATE >= mdy("01-01-2020") & TX_DATE <= mdy("03-31-2020") ~ "Jan-Mar 2020",
      TX_DATE >= mdy("04-01-2020") & TX_DATE <= mdy("06-30-2020") ~ "Apr-Jun 2020",
      TX_DATE >= mdy("07-01-2020") & TX_DATE <= mdy("09-30-2020") ~ "Jul-Sep 2020",
      TX_DATE >= mdy("10-01-2020") & TX_DATE <= mdy("12-31-2020") ~ "Oct-Dec 2020",
      TX_DATE >= mdy("01-01-2021") & TX_DATE <= mdy("03-31-2021") ~ "Jan-Mar 2021",
      TX_DATE >= mdy("04-01-2021") & TX_DATE <= mdy("04-30-2021") ~ "Apr 2021",
      TX_DATE >= mdy("05-01-2021") & TX_DATE <= mdy("05-31-2021") ~ "May 2021",
      TX_DATE >= mdy("06-01-2021") & TX_DATE <= mdy("06-30-2021") ~ "Jun 2021",
      TX_DATE >= mdy("07-01-2021") & TX_DATE <= mdy("09-30-2021") ~ "Jul-Sep 2021",
      TX_DATE >= mdy("10-01-2021") & TX_DATE <= mdy("12-31-2021") ~ "Oct-Dec 2021",
      TX_DATE >= mdy("01-01-2022") & TX_DATE <= mdy("03-31-2022") ~ "Jan-Mar 2022",
      TX_DATE >= mdy("04-01-2022") & TX_DATE <= mdy("06-30-2022") ~ "Apr-Jun 2022",
      TX_DATE >= mdy("07-01-2022") & TX_DATE <= mdy("09-30-2022") ~ "Jul-Sep 2022",
      TX_DATE >= mdy("10-01-2022") & TX_DATE <= mdy("12-31-2022") ~ "Oct-Dec 2022",
      TX_DATE >= mdy("01-01-2022") & TX_DATE <= mdy("03-31-2023") ~ "Jan-Mar 2023",
      TX_DATE >= mdy("04-01-2022") & TX_DATE <= mdy("06-30-2023") ~ "Apr-Jun 2023",
      TX_DATE >= mdy("07-01-2022") & TX_DATE <= mdy("09-30-2023") ~ "Jul-Sep 2023",
      TX_DATE >= mdy("10-01-2022") & TX_DATE <= mdy("12-31-2023") ~ "Oct-Dec 2023",
      TX_DATE >= mdy("01-01-2022") & TX_DATE <= mdy("03-31-2024") ~ "Jan-Mar 2024",
      TX_DATE >= mdy("04-01-2022") & TX_DATE <= mdy("06-30-2024") ~ "Apr-Jun 2024",
      TX_DATE >= mdy("07-01-2022") & TX_DATE <= mdy("09-30-2024") ~ "Jul-Sep 2024",
      TX_DATE >= mdy("10-01-2022") & TX_DATE <= mdy("12-31-2024") ~ "Oct-Dec 2024",
      TX_DATE >= mdy("01-01-2022") & TX_DATE <= mdy("03-31-2025") ~ "Jan-Mar 2025",
      TX_DATE >= mdy("04-01-2022") & TX_DATE <= mdy("06-30-2025") ~ "Apr-Jun 2025"),
    timing_of_transplants = factor(timing_of_transplants, levels = c("Apr-Jun 2016", "Jul-Sep 2016", "Oct-Dec 2016", "Jan-Mar 2017", "Apr-Jun 2017", "Jul-Sep 2017", "Oct-Dec 2017", "Jan-Mar 2018", "Apr-Jun 2018", "Jul-Sep 2018", "Oct-Dec 2018", "Jan-Mar 2019", "Apr-Jun 2019", "Jul-Sep 2019", "Oct-Dec 2019", "Jan-Mar 2020", "Apr-Jun 2020", "Jul-Sep 2020", "Oct-Dec 2020", "Jan-Mar 2021", "Apr 2021", "May 2021", "Jun 2021", "Jul-Sep 2021", "Oct-Dec 2021", "Jan-Mar 2022", "Apr-Jun 2022", "Jul-Sep 2022", "Oct-Dec 2022", "Jan-Mar 2023", "Apr-Jun 2023", "Jul-Sep 2023", "Oct-Dec 2023", "Jan-Mar 2024", "Apr-Jun 2024", "Jul-Sep 2024", "Oct-Dec 2024", "Jan-Mar 2025", "Apr-Jun 2025")))



by_month <- barplotdata %>%
  group_by(timing_of_transplants) %>%
  count(status) %>%
  mutate(total_per_month = sum(n)) %>%
  ungroup() %>%
  mutate(percentage_per_month = 100*n/total_per_month) 
# policy_switch <- which(levels(by_month$month) == "Jun 2021")
# pre_policy_start <- which(levels(by_month$month) == "Jul 2017")
# pre_policy_end <- which(levels(by_month$month) == "Feb 2021")
# post_policy_start <- which(levels(by_month$month) == "Jul 2021")
# post_policy_end <- which(levels(by_month$month) == "Feb 2025")


exceptions_at_transplant_barplot <- ggplot(by_month, aes(x = timing_of_transplants, y = percentage_per_month, fill = status, group = status)) +
  geom_col(alpha = 0.75, color = "NA") +
  geom_vline(aes(xintercept = "Jun 2021", linetype = "NHRB Implementation Date")) + 
  #scale_color_custom(name = "Exception Status at Transplant", palette = "simple") +
  labs(
    x = "",
    y = "% Exceptions at Transplant",
    linetype = "",
    fill = "status") +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 300, by = 10)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.position = "bottom",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.margin = margin(t=0, r=0, b=0, l=0, unit = "mm"),
        legend.direction = "vertical",
        legend.title.align = 0,
        panel.background = element_rect(fill = "grey99"),
        plot.background = element_rect(fill = "white"),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(linewidth = 0.5, linetype = "solid", colour = "black")
  ) +
  scale_linetype_manual(values = c("dashed", "dotted", "solid")) +
  scale_fill_manual(name = "", values = c("#b24745", "white"), breaks = c("Status 1A/1B Exception")) + 
  guides(fill = guide_legend(nrow = 2)) +
  annotate("text", x = "Apr-Jun 2019", y = 28, label= "Pre-NHRB Cohort", size = 16/.pt) +
  annotate("text", x = "Apr-Jun 2023", y = 28, label= "Post-NHRB Cohort", size = 16/.pt) +
  annotate("rect",
           xmin = "Jul-Sep 2017",           
           xmax = "Jan-Mar 2021",
           ymin = 0, 
           ymax = 30,  
           alpha = 0.15) +
  annotate("rect",
           xmin = "Jul-Sep 2021",            
           xmax = "Jan-Mar 2025",            
           ymin = 0, 
           ymax = 30, 
           alpha = 0.15) 



```






``` {r exceptions during listing}

exceptionsduringlisting <- cand_hx_list_episodes_grouping %>% group_by(WL_ID_CODE) %>% arrange(CHG_DATE) %>% period_to_months(CHG_DATE, CHG_END_DATE) %>% ungroup() %>% group_by(WL_ID_CODE, start) %>%
  mutate(
    exception_during_month = case_when(
      any(EXCEPTION == 1) ~ 1,
      TRUE ~ 0)) %>% slice(1)

#this line of code TAKES FOREVER!
calculations_for_exceptions <- exceptionsduringlisting %>% 
  mutate(
    period_time = case_when(
      CHG_DATE >= mdy("07-01-2017") & CHG_DATE <= mdy("02-01-2021") ~ "pre",
      CHG_DATE >= mdy("07-01-2021") & CHG_DATE <= mdy("02-01-2025") ~ "post",
      TRUE ~ "other")) %>%
  select(WL_ID_CODE, period, exception_during_month, period_time) %>% ungroup() %>% 
  group_by(period_time) %>% summarise(total = n(), exceptions_each_month = sum(exception_during_month), na.rm = TRUE) %>%
  mutate(exceptionproportion = exceptions_each_month / total)


calculations_for_exceptions <- calculations_for_exceptions %>% filter(period_time != "other") %>% 
  mutate(no_exceptions_each_month = total - exceptions_each_month)


calculations_for_exceptions %>% select(no_exceptions_each_month, exceptions_each_month) %>% chisq.test()





hasexception <- exceptionsduringlisting %>% filter(exception_during_month == 1) %>% 
  mutate(EXCEPTION_STATUS_GRAPH = case_when(
    exception_during_month == 1 ~ "Status 1A/1B Exception"))

noexception <- exceptionsduringlisting %>% 
  mutate(EXCEPTION_STATUS_GRAPH = case_when(
    exception_during_month == 0 | exception_during_month == 1 ~ "Total"))

trendplot <- rbind(hasexception, noexception) %>% filter(CHG_DATE >= mdy("07-01-2017") & CHG_DATE <= mdy("06-30-2025"))

trendplot <- trendplot %>%
  mutate(month = zoo::as.yearmon(CHG_DATE),
         status = factor(EXCEPTION_STATUS_GRAPH,
                         levels = c("Total", "Status 1A/1B Exception")))




by_month <- trendplot %>%
  group_by(month) %>%
  count(status) %>%
  mutate(total_per_month = sum(n)) %>%
  ungroup() %>%
  mutate(month = factor(month),
         percentage_per_month = 100*n/total_per_month) 

policy_switch <- which(levels(by_month$month) == "Jun 2021")
pre_policy_start <- which(levels(by_month$month) == "Jul 2017")
pre_policy_end <- which(levels(by_month$month) == "Feb 2021")
post_policy_start <- which(levels(by_month$month) == "Jul 2021")
post_policy_end <- which(levels(by_month$month) == "Feb 2025")

# exceptions_during_listing_lineplot <- ggplot(by_month, aes(x = month, y = n, color = status, group = status)) +
#   geom_line() + 
#   geom_point() +
#   geom_vline(aes(xintercept = policy_switch, linetype = "NHRB Implementation Date")) + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
#         axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size = 20),
#         axis.text.y = element_text(size = 18),
#         axis.title.y = element_text(size = 20),
#         legend.position = "bottom",
#         legend.title = element_text(size = 20),
#         legend.text = element_text(size = 20),
#         legend.margin = margin(t=0, r=0, b=0, l=0, unit = "mm"),
#         legend.direction = "vertical",
#         legend.title.align = 0,
#         panel.background = element_rect(fill = "grey99"),
#         plot.background = element_rect(fill = "white"),
#         panel.border = element_blank(),
#         panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.line = element_line(linewidth = 0.5, linetype = "solid", colour = "black")
#   ) +
#   labs(
#     x = "Month of Listing",
#     y = "Number of Active\nListings per Month",
#     linetype = "",
#     color = "Exception Status"
#   ) +
#   scale_linetype_manual(values = c("dashed", "dotted", "solid")) +
#   scale_fill_custom(palette = "simple") +
#   guides(colour = guide_legend(nrow = 1)) +
#   annotate("text", x = which(levels(by_month$month) == "May 2019"), y = 1900, label= "Pre-NHRB Cohort", size = 20/.pt) +
#   annotate("text", x = which(levels(by_month$month) == "May 2023"), y = 1900, label= "Post-NHRB Cohort", size = 20/.pt) +
#   annotate("rect",
#            xmin = which(levels(by_month$month) == "Jul 2017"),           
#            xmax = which(levels(by_month$month) == "Feb 2021"),
#            ymin = 0, 
#            ymax = 2000,  
#            alpha = 0.15) +
#   annotate("rect",
#            xmin = which(levels(by_month$month) == "Jul 2021"),            
#            xmax = which(levels(by_month$month) == "Feb 2025"),            
#            ymin = 0, 
#            ymax = 2000, 
#            alpha = 0.15) 




exceptions_during_listing_barplot <- ggplot(by_month, aes(x = month, y = percentage_per_month, fill = status, group = status)) +
  geom_col(alpha = 0.75, color = "NA") +
  geom_vline(aes(xintercept = policy_switch, linetype = "NHRB Implementation Date")) + 
  labs(
    x = "Month of Listing",
    y = "% Listings with Status 1A/1B\nExceptions per Month",
    linetype = "",
    fill = "status") +
  scale_color_custom(name = "Exception Status at Transplant", palette = "simple") +
  theme(legend.position = "bottom") +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0), size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.position = "bottom",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.margin = margin(t=0, r=0, b=0, l=0, unit = "mm"),
        legend.direction = "vertical",
        legend.title.align = 0,
        panel.background = element_rect(fill = "grey99"),
        plot.background = element_rect(fill = "white"),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(linewidth = 0.5, linetype = "solid", colour = "black")
  ) +
  scale_linetype_manual(values = c("dashed", "dotted", "solid")) +
  scale_fill_manual(name = "", values = c("#00a1d5", "white"), breaks = c("Status 1A/1B Exception")) +
  guides(colour = guide_legend(nrow = 1)) +
  annotate("text", x = which(levels(by_month$month) == "May 2019"), y = 18, label= "Pre-NHRB Cohort", size = 20/.pt) +
  annotate("text", x = which(levels(by_month$month) == "May 2023"), y = 18, label= "Post-NHRB Cohort", size = 20/.pt) +
  annotate("rect",
           xmin = which(levels(by_month$month) == "Jul 2017"),           
           xmax = which(levels(by_month$month) == "Feb 2021"),
           ymin = 0, 
           ymax = 20,  
           alpha = 0.15) +
  annotate("rect",
           xmin = which(levels(by_month$month) == "Jul 2021"),            
           xmax = which(levels(by_month$month) == "Feb 2025"),            
           ymin = 0, 
           ymax = 20, 
           alpha = 0.15) 


figure2 <- plot_grid(exceptions_during_listing_barplot, exceptions_during_listing_lineplot,
                     ncol = 1, nrow = 2,
                     labels = c("A", "B"))



```





``` {r posttx survival}

heart_transplants$EXCEPTION <- factor(heart_transplants$EXCEPTION,
                                      levels = c("0", "1"), # Assuming 0 is censored, adjust if different 
                                      labels = c("No Exception at Transplant", "Status Exception at Transplant"))

heart_transplants = heart_transplants %>% 
  mutate(EXC = ifelse(EXCEPTION == "No Exception at Transplant", "No Exception", "Exception"),
         EXC = factor(EXC, levels = c("No Exception", "Exception")),
         STATUS = factor(STATUS, levels = c("1A", "1B", "2")))

fig2 = ggplot(heart_transplants, aes(x = STATUS, fill = EXC)) + 
  geom_bar() + 
  labs(x = "Status", y = "Number of Transplant Recipients", fill = "Exception Status") +
  scale_fill_manual(values = c("#00a1d5", "#374e55", "#df8f44")) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))


heart_transplants_status1a = heart_transplants %>% filter(STATUS == "1A")

heart_transplants_status1b = heart_transplants %>% filter(STATUS == "1B")

custom_labels <- c("No Exception\nat Transplant", "Status Exception\nat Transplant")


km <- Surv(time = heart_transplants$post_transplant_time, event = heart_transplants$post_transplant_death)
km_fit <- survfit2(km ~ EXCEPTION, data = heart_transplants) # Example: grouping by 'sex'

summary(km_fit, times = 365)

km_plot = ggsurvfit(km_fit) + 
  add_risktable(
    size = 6, # Adjust the size for the statistics
    theme = list(
      # Use theme_risktable_default() and modify the text sizes
      theme_risktable_default(axis.text.y.size = 18, plot.title.size = 18),
      # Use ggplot2's theme() for more detailed control, such as making the title bold
      theme(plot.title = element_text(face = "bold"))
    )
  ) +
  #add_risktable(size = 6) +
  #theme_risktable_default(axis.text.y.size = 6, plot.title.size = 6) +
  add_confidence_interval(alpha = 0.4) +
  scale_ggsurvfit() +
  scale_color_manual(values = c("#374e55", "#df8f44"),
                     labels = custom_labels) +
  scale_fill_manual(values = c("#374e55", "#df8f44"),
                    labels = custom_labels) +
  scale_x_continuous(limits = c(0, 360), breaks = c(0, 60, 120, 180, 240, 300, 360)) +
  add_censor_mark() +
  labs(x = "Days after Transplant") +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)) +
  add_pvalue(location = "annotation", x = 300, y = 0.8, size = 6, pvalue_fun = \(x) format_p(x, digits = 2))
  

km_plot

km_1a <- Surv(time = heart_transplants_status1a$post_transplant_time, event = heart_transplants_status1a$post_transplant_death)
km_fit_1a <- survfit2(km_1a ~ EXCEPTION, data = heart_transplants_status1a) # Example: grouping by 'sex'

summary(km_fit_1a, times = 365)


custom_labels_1a <- c("Status 1A at Transplant,\nNo Exception", "Status 1A at Transplant,\nException")

km_plot_1a = ggsurvfit(km_fit_1a) + 
  add_risktable(
    size = 6, # Adjust the size for the statistics
    theme = list(
      # Use theme_risktable_default() and modify the text sizes
      theme_risktable_default(axis.text.y.size = 18, plot.title.size = 18),
      # Use ggplot2's theme() for more detailed control, such as making the title bold
      theme(plot.title = element_text(face = "bold"))
    )
  ) +
  #add_risktable(size = 6) +
  #theme_risktable_default(axis.text.y.size = 6, plot.title.size = 6) +
  add_confidence_interval(alpha = 0.4) +
  scale_ggsurvfit() +
  scale_color_manual(values = c("#374e55", "#df8f44"),
                     labels = custom_labels_1a) +
  scale_fill_manual(values = c("#374e55", "#df8f44"),
                    labels = custom_labels_1a) +
  scale_x_continuous(limits = c(0, 360), breaks = c(0, 60, 120, 180, 240, 300, 360)) +
  add_censor_mark() +
  labs(x = "Days after Transplant") +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "bottom") +
  add_pvalue(location = "annotation", x = 300, y = 0.8, size = 6, pvalue_fun = \(x) format_p(x, digits = 2))
  
custom_labels_1b <- c("Status 1B at Transplant,\nNo Exception", "Status 1B at Transplant,\nException")

km_1b <- Surv(time = heart_transplants_status1b$post_transplant_time, event = heart_transplants_status1b$post_transplant_death)
km_fit_1b <- survfit2(km_1b ~ EXCEPTION, data = heart_transplants_status1b) # Example: grouping by 'sex'

summary(km_fit_1b, times = 365)


km_plot_1b = ggsurvfit(km_fit_1b) + 
  add_risktable(
    size = 6, # Adjust the size for the statistics
    theme = list(
      # Use theme_risktable_default() and modify the text sizes
      theme_risktable_default(axis.text.y.size = 18, plot.title.size = 18),
      # Use ggplot2's theme() for more detailed control, such as making the title bold
      theme(plot.title = element_text(face = "bold"))
    )
  ) +
  #add_risktable(size = 6) +
  #theme_risktable_default(axis.text.y.size = 6, plot.title.size = 6) +
  add_confidence_interval(alpha = 0.4) +
  scale_ggsurvfit() +
  scale_color_manual(values = c("#374e55", "#df8f44"),
                     labels = custom_labels_1b) +
  scale_fill_manual(values = c("#374e55", "#df8f44"),
                    labels = custom_labels_1b) +
  scale_x_continuous(limits = c(0, 360), breaks = c(0, 60, 120, 180, 240, 300, 360)) +
  add_censor_mark() +
  labs(x = "Days after Transplant") +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "bottom") +
  add_pvalue(location = "annotation", x = 300, y = 0.8, size = 6, pvalue_fun = \(x) format_p(x, digits = 2))



km_figures <- cowplot::plot_grid(km_plot_1a, km_plot_1b,
                        ncol = 2, nrow = 1,
                        labels = c("A", "B"))


post_tx_death <- coxme(Surv(post_transplant_time, post_transplant_death) ~ EXCEPTION + STATUS + (1 | LISTING_CTR_CODE), data = heart_transplants)



summary(post_tx_death)
exp(confint(post_tx_death))

post_tx_death_plot = plot_model(
  post_tx_death,
  show.values = TRUE,
  value.offset = .3,
  value.size = 6,
  axis.labels = c(
    "Status 1B",
    "Status 1A",
    "Exception"),
  title = "",
  axis.title = "Hazard Ratio of Post-Transplant Mortality",
  grid.breaks = c(0.01, 0.1, 1, 10, 100)) +
  theme_classic() +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))









```

``` {r auc}

require(rsample)
require(risksetROC)

data_for_cindex = cand_hx_list_episodes_grouping %>% dplyr::select(WL_ID_CODE, INIT_AGE, TCR_DGN, start, end, death, EXCEPTION, STATUS) %>%
  group_by(WL_ID_CODE) %>% arrange(WL_ID_CODE, start) %>%
  mutate(
    status_without_exception = case_when(
      STATUS == "1B" & EXCEPTION == 1 ~ "2",
      STATUS == "1A" & EXCEPTION == 1 ~ "1B",
      TRUE ~ STATUS),
    new_status_normal = case_when(
      STATUS == "1A" ~ 1,
      STATUS == "1B" ~ 2,
      STATUS == "2" ~ 3),
    new_status_hypothetical = case_when(
      status_without_exception == "1A" ~ 1,
      status_without_exception == "1B" ~ 2,
      status_without_exception == "2" ~ 3),
    death_6weeks = ifelse(death == 1 & end <= 42, 1, 0),
    death_6weeks = ifelse(any(death_6weeks == 1), 1, 0)
    )

auc_graph_data = data_for_cindex %>% slice(1) %>%
  mutate(
    auc_status_with_exception = case_when(
      STATUS == "1A" ~ 1,
      STATUS == "1B" ~ 2,
      STATUS == "2" ~ 3),
    auc_status_without_exception = case_when(
      status_without_exception == "1A" ~ 1,
      status_without_exception == "1B" ~ 2,
      status_without_exception == "2" ~ 3),
    auc_status_with_exception = factor(auc_status_with_exception, ordered = TRUE, levels = c(1, 2, 3), labels = c("Status 1A", "Status 1B", "Status 2")),
    auc_status_without_exception = factor(auc_status_without_exception, ordered = TRUE, levels = c(1, 2, 3), labels = c("Status 1A", "Status 1B", "Status 2")),
    nope = factor(STATUS, ordered = TRUE, levels = c("1A", "1B", "2")))


par(xaxs='i')
par(pty = "s")
par(cex.axis = 1.2, cex.lab = 1.2) 
# First ROC curve (plots the graph and the first AUC label)
pROC::roc(data = auc_graph_data, response = death_6weeks, predictor = nope, direction='>',
          plot=T, col="#374e55", print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, 
          #print.thres = c("Status 1A", "Status 1B", "Status 2"), 
          #print.thres = c("1A", "1B", "2"),
          print.thres = c("no"),
          print.thres.cex = 1.1, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2, 
          legacy.axes=T,
          print.auc.y = 0.4,
          identity = TRUE, # Add the identity line (diagonal)
          lty.identity = 2, # Line type for the identity line (2 for dotted)
          col.identity = "darkgrey")

# Second ROC curve (adds to the graph and prints the second AUC label at a new y-coordinate)
pROC::roc(data = auc_graph_data, response = death_6weeks, predictor = auc_status_without_exception, direction='>',
          plot=T, col="#df8f44", print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, 
          print.thres = c("no"), 
          print.thres.cex = 1.1, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2, 
          legacy.axes=T,
          add = T,
          print.auc.y = 0.35) # Adjust this value (e.g., 0.35, 0.45) to move the label

#text(x=0.05, y=1.02, labels='')
legend('bottomright', xpd = T, 
       legend = c('With Status Exceptions', 'No Status Exceptions'),
       col = c("#374e55", "#df8f44"), lwd=2.0, cex=1.0)

```



``` {r auc}

require(rsample)
require(risksetROC)

data_for_cindex = cand_hx_list_episodes_grouping %>% dplyr::select(WL_ID_CODE, INIT_AGE, TCR_DGN, start, end, death, EXCEPTION, STATUS) %>%
  group_by(WL_ID_CODE) %>% arrange(WL_ID_CODE, start) %>%
  mutate(
    status_without_exception = case_when(
      STATUS == "1B" & EXCEPTION == 1 ~ "2",
      STATUS == "1A" & EXCEPTION == 1 ~ "1B",
      TRUE ~ STATUS),
    new_status_normal = case_when(
      STATUS == "1A" ~ 1,
      STATUS == "1B" ~ 2,
      STATUS == "2" ~ 3),
    new_status_hypothetical = case_when(
      status_without_exception == "1A" ~ 1,
      status_without_exception == "1B" ~ 2,
      status_without_exception == "2" ~ 3),
    death_6weeks = ifelse(death == 1 & end <= 42, 1, 0),
    death_6weeks = ifelse(any(death_6weeks == 1), 1, 0)
    )

auc_graph_data = data_for_cindex %>% slice(1) %>%
  mutate(
    auc_status_with_exception = case_when(
      STATUS == "1A" ~ 1,
      STATUS == "1B" ~ 2,
      STATUS == "2" ~ 3),
    auc_status_without_exception = case_when(
      status_without_exception == "1A" ~ 1,
      status_without_exception == "1B" ~ 2,
      status_without_exception == "2" ~ 3),
    auc_status_with_exception = factor(auc_status_with_exception, ordered = TRUE, levels = c(1, 2, 3), labels = c("Status 1A", "Status 1B", "Status 2")),
    auc_status_without_exception = factor(auc_status_without_exception, ordered = TRUE, levels = c(1, 2, 3), labels = c("Status 1A", "Status 1B", "Status 2")),
    nope = factor(STATUS, ordered = TRUE, levels = c("1A", "1B", "2")))

roc_obj <- pROC::roc(auc_graph_data$death_6weeks, auc_graph_data$nope, direction = ">")
pROC::ggroc(roc_obj)

par(xaxs='i')
par(pty = "s")
par(cex.axis = 1.2, cex.lab = 1.2) 
# First ROC curve (plots the graph and the first AUC label)
pROC::roc(data = auc_graph_data, response = death_6weeks, predictor = nope, direction='>',
          plot=T, col="#374e55", print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, 
          #print.thres = c("Status 1A", "Status 1B", "Status 2"), 
          #print.thres = c("1A", "1B", "2"),
          print.thres = c("no"),
          print.thres.cex = 1.1, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2, 
          legacy.axes=T,
          print.auc.y = 0.4,
          identity = TRUE, # Add the identity line (diagonal)
          lty.identity = 2, # Line type for the identity line (2 for dotted)
          col.identity = "darkgrey")

# Second ROC curve (adds to the graph and prints the second AUC label at a new y-coordinate)
pROC::roc(data = auc_graph_data, response = death_6weeks, predictor = auc_status_without_exception, direction='>',
          plot=T, col="#df8f44", print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, 
          print.thres = c("no"), 
          print.thres.cex = 1.1, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2, 
          legacy.axes=T,
          add = T,
          print.auc.y = 0.35) # Adjust this value (e.g., 0.35, 0.45) to move the label

#text(x=0.05, y=1.02, labels='')
legend('bottomright', xpd = T, 
       legend = c('With Status Exceptions', 'No Status Exceptions'),
       col = c("#374e55", "#df8f44"), lwd=2.0, cex=1.0)



current = pROC::roc(data = auc_graph_data, response = death_6weeks, predictor = nope, direction='>',
          plot=T, col="#374e55", print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, 
          #print.thres = c("Status 1A", "Status 1B", "Status 2"), 
          #print.thres = c("1A", "1B", "2"),
          print.thres = c("no"),
          print.thres.cex = 1.1, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2, 
          legacy.axes=T,
          print.auc.y = 0.4,
          identity = TRUE, # Add the identity line (diagonal)
          lty.identity = 2, # Line type for the identity line (2 for dotted)
          col.identity = "darkgrey")

hypothetical = pROC::roc(data = auc_graph_data, response = death_6weeks, 
                         predictor = auc_status_without_exception, direction='>', 
                         plot=T, col="#df8f44", print.auc=T, ci=T, ci.type = 'no',
                         lwd=3, quiet=T, print.thres = c("no"), print.thres.cex = 1.1, print.thres.pattern= "Status%2.f",
                         print.auc.cex = 1.2, legacy.axes=T, print.auc.y = 0.35) 


currentvalues = coords(current, c(1, 2, 3))
hypotheticalvalues = coords(hypothetical, c(1, 2, 3))

```


``` {r c index}


normalallocation <- coxph(Surv(start, end, death) ~ new_status_normal, data = data_for_cindex)
data_for_cindex$normal_predict <- predict(normalallocation, data_for_cindex, type = "lp")
get_normal_c <- function(data) {
  r <- risksetAUC(
    Stime = data$end,
    entry = data$start,
    status = data$death,
    marker = data$normal_predict,
    method = "Cox",
    tmax = 365,
    plot = F)
  return(r$Cindex)
}


timeseriesdata_short1 <- data_for_cindex[ ,c("WL_ID_CODE", "start", "end", "death", "normal_predict")]
timeseriesdata_nest1 <- timeseriesdata_short1 %>% nest(data = -WL_ID_CODE)

set.seed(200)
get_normal_c(data_for_cindex)

n_iterations <- 1000
bs <- rsample::bootstraps(timeseriesdata_nest1, times = n_iterations)
auc_normal <- vector(length = n_iterations)

for (i in 1:n_iterations) {
  normal_c <- as_tibble(bs$splits[[i]]) %>% unnest(cols = c("data")) %>% as.data.frame()
  auc_normal[i] <- get_normal_c(normal_c)
}


quantile(auc_normal, probs = c(0.025, 0.975))

     2.5%     97.5% 
0.6817518 0.7059445


hypotheticalallocation <- coxph(Surv(start, end, death) ~ new_status_hypothetical, data = data_for_cindex)
data_for_cindex$hypothetical_predict <- predict(hypotheticalallocation, data_for_cindex, type = "lp")
get_hypothetical_c <- function(data) {
  r <- risksetAUC(
    Stime = data$end,
    entry = data$start,
    status = data$death,
    marker = data$hypothetical_predict,
    method = "Cox",
    tmax = 365,
    plot = F)
  return(r$Cindex)
}

timeseriesdata_short2 <- data_for_cindex[ ,c("WL_ID_CODE", "start", "end", "death", "hypothetical_predict")]
timeseriesdata_nest2 <- timeseriesdata_short2 %>% nest(data = -WL_ID_CODE)

set.seed(200)
get_hypothetical_c(data_for_cindex)


n_iterations <- 1000
bs1 <- rsample::bootstraps(timeseriesdata_nest2, times = n_iterations)
auc_hypothetical <- vector(length = n_iterations)

for (i in 1:n_iterations) {
  hypothetical_c <- as_tibble(bs1$splits[[i]]) %>% unnest(cols = c("data")) %>% as.data.frame()
  auc_hypothetical[i] <- get_hypothetical_c(hypothetical_c)
}


quantile(auc_hypothetical, probs = c(0.025, 0.975))

compareC(data_for_cindex$end, data_for_cindex$death, data_for_cindex$new_status_normal, data_for_cindex$new_status_hypothetical)


c_boxplot = boxplot(auc_normal, auc_hypothetical, names = c("With Exceptions", "Without Exceptions"), col = c("lightblue", "lightgreen"))


data_df <- data.frame(
  value = c(auc_normal, auc_hypothetical),
  group = factor(c(rep("With Exceptions", length(auc_normal)), rep("Without Exceptions", length(auc_hypothetical)))))
    
c_boxplot = ggplot(data_df, aes(x = group, y = value, fill = group)) +
  geom_boxplot() +
  labs(title = "",
       x = "Concordance Indices",
       y = "Value") +
  theme_classic() +
  scale_fill_manual(values = c("With Exceptions" = "#374e55", "Without Exceptions" = "#df8f44")) +
  ylim(0.65, 0.75) +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.position = "none")
    
# Find max y-value to determine the annotation's vertical position
max_y <- max(data_df$value)
y_pos <- max_y + 0.005 # Position the bracket slightly above the highest point

# Annotation data frame for geom_segment and geom_text
signif_annot <- data.frame(
  x_start = 1, # x-position of "With Exceptions"
  x_end = 2,   # x-position of "Without Exceptions"
  y_bar = y_pos,
  y_text = y_pos + 0.002,
  label = "***"
)

# Create the boxplot with the manually added significance indicator
c_boxplot <- ggplot(data_df, aes(x = group, y = value, fill = group)) +
  geom_boxplot() +
  labs(title = "",
       x = "Concordance Indices",
       y = "Value") +
  theme_classic() +
  scale_fill_manual(values = c("With Exceptions" = "#374e55", "Without Exceptions" = "#df8f44")) +
  ylim(0.65, 0.75) +
  theme(text = element_text(size = 20),
        axis.text.x = element_text(size = 18),
        axis.title.x = element_text(size = 20),
        axis.text.y = element_text(size = 18),
        axis.title.y = element_text(size = 20),
        legend.position = "none") +
  # Add horizontal segment for the bracket
  geom_segment(data = signif_annot, aes(x = x_start, xend = x_end, y = y_bar, yend = y_bar), inherit.aes = FALSE) +
  # Add vertical tips to the bracket
  geom_segment(data = signif_annot, aes(x = x_start, xend = x_start, y = y_bar, yend = y_bar - 0.001), inherit.aes = FALSE) +
  geom_segment(data = signif_annot, aes(x = x_end, xend = x_end, y = y_bar, yend = y_bar - 0.001), inherit.aes = FALSE) +
  # Add the significance text
  geom_text(data = signif_annot, aes(x = (x_start + x_end) / 2, y = y_text, label = label), size = 7, inherit.aes = FALSE)

```

